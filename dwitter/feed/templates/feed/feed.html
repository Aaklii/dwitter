{% extends 'base.html' %}
{% load subdomainurls %}

{% block header_title %} 
{{ header_title }}
{% endblock %}
{% block pagecontrol %} 
<a class=button href="{{ prev_url }}">&laquo;</a> Page: {{ page_nr }} <a class=button href="{{ next_url }}">&raquo;</a>
{% endblock %}

{% block content %}
<div class=dweet-feed>
  <div class=submit-box>
    <div class=canvas-iframe-container-wrapper>
      <div class=canvas-iframe-container 
        id="iframe-container-submit">
      </div>
    </div>
    <form action="{% url 'dweet' %}" method="post">
      {% csrf_token %}
      <textarea
        name=code
        class=code-input
        id=editor
        maxlength=140
        rows=4
        >c.width=1920;x.fillRect(800+S(t)*300,400,200,200)</textarea>
      <br />
      <input  
      class=dweet-button
      type="submit" 
      value="Dweet!" />
    </form>
    <br />
    <code>
      Will be called 60 times per second.
      t: Elapsed time in seconds.
      S: Shorthand for Math.sin.
      C: Shorthand for Math.cos.
      T: Shorthand for Math.tan.
      R: Function that generates rgba-strings, usage ex.: R(255, 255, 255, 0.5)
      c: A 1920x1080 canvas.
      x: A 2D context for that canvas. 
    </code>
    <script>
      (function() {
        var editor = document.querySelector('#editor');
        oldCode = editor.value;
        replaceIframe(oldCode);
        editor.addEventListener('keyup', function() {
          if(editor.value == oldCode) {
            return;
          }
          editor.size = Math.max(editor.value.length, 1);
          replaceIframe(editor.value);
          oldCode = editor.value;
        });

        function replaceIframe(code) {
          var iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-scripts';
          var iframeContent = encodeURIComponent(
          '<!DOCTYPE html>' +
          '<head>' +
            '<style>' +
              '* {padding:0;margin:0;border:0;outline:0;overflow:hidden}' +
              'canvas {' +
                'width: 100%;' +
                'background: white;' +
                '}' +
              '</style>' +
            '</head>' +
          '<body>' +
            '<canvas id=c></canvas>' +
            '<script>' +
              'var c = document.querySelector("#c");' +
              'c.width = 1920;' +
              'c.height = 1080;' +
              'var S = Math.sin;' +
              'var C = Math.cos;' +
              'var T = Math.tan;' +
              'var R = function(r,g,b,a) {' +
                'a = a === undefined ? 1 : a;' +
                'return "rgba("+(r|0)+","+(g|0)+","+(b|0)+","+a+")";' +
                '};' +
              'var x = c.getContext("2d");' +
              'var startT = +new Date(); ' +
              'function u(t) {' +
                code +
                '};' +
              'function loop() {' +
                'requestAnimationFrame(loop);' +
                'u((new Date() - startT) / 1000);' +
                '};' +
              'loop();' +
              '</scr' + 'ipt>');
              iframe.src = 'data:text/html;charset=utf-8,' + iframeContent;
              var container = document.querySelector('#iframe-container-submit');
              container.innerHTML = '';
              container.appendChild(iframe);
            }
        })();

      </script>
    </div>

    {% for dweet in dweet_list %}
    <div class=dweet>
      <div class=canvas-iframe-container-wrapper>
        <div class=canvas-iframe-container >
          <iframe id="iframe{{ forloop.counter0 }}" src="{% url 'fullscreen_dweet' subdomain='dweet' dweet_id=dweet.id %}"></iframe>
        </div>
      </div>
      <div class=dweet-actions>
        <a class=score-text> {{ dweet.likes.count }} </a> <a href="{% url 'like' post_id=dweet.id %}"> Awesome! </a>
        &nbsp;&nbsp;&nbsp;<a id="pause-link{{ forloop.counter0 }}" href>Play/Pause</a>
        <script>
          var pauselink = document.querySelector('#pause-link{{ forloop.counter0 }}');
          pauselink.addEventListener('click', function(event) {
            event.preventDefault();
            var dweetwindow = document.querySelector("#iframe{{ forloop.counter0 }}");
            win =  dweetwindow.contentWindow || dweetwindow;
            console.log(win);
            win.postMessage("toggle","http://dweet.localhost:8000");
          });
        </script>
        <a class=arktis-link id=arktis-link-{{dweet.id}} href="{% url 'fullscreen_dweet' subdomain='dweet' dweet_id=dweet.id %}" >fullscreen</a>
      </div>
      <div class=dweet-author><a href="{% url 'user_feed' url_username=dweet.author.username %}">{{ dweet.author.username }}</a></div>
      <div class=dweet-code>
        {% for char in dweet.code|make_list %}<span class=code-letter><code>{{ char }}</code></span>{% endfor %}
      </div>
    </div>
  {% endfor %}
{% endblock %}

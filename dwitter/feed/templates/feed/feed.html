<html>
  <head>
    <title>Dwitter</title>
    <link rel=stylesheet href='static/main.css' >
    <style>

    </style>
  </head>
  <body>
    <div class=head-menu>
      <div class=head-account-info>
        {% if request.user.is_authenticated %}
        Logged in as {{ request.user.username }}. <a class=button href="{% url 'auth_logout' %}"> Log out </a>
        {% else %}
        <a href="{% url 'auth_login'  %}" > Login </a> 
        {% endif %}
      </div>
      <div class=header-center-div>
        <h2 class=header-title>{{ header_title }}</h2>
        <br />
        <a class=button href="{{ prev_url }}">&laquo;</a> Page: {{ page_nr }} <a class=button href="{{ next_url }}">&raquo;</a>
      </div>
    </div>




    <div class=dweet-feed>
      <div class=submit-box>
        <div class=canvas-iframe-container-wrapper>
          <div class=canvas-iframe-container 
            id="iframe-container-submit">
          </div>
        </div>
        <form action="{% url 'dweet' %}" method="post">
          {% csrf_token %}
          <textarea
            name=code
            class=code-input
            id=editor
            maxlength=140
            rows=4
            >x.fillRect(800,400,200,200)</textarea>
          <br />
          <input  
          class=dweet-button
          type="submit" 
          value="Dweet!" />
        </form>
        <br />
        <code>
          Will be called 60 times per second.
          t: Elapsed time in seconds.
          S: Shorthand for Math.sin.
          C: Shorthand for Math.cos.
          T: Shorthand for Math.tan.
          R: Function that generates rgba-strings, usage ex.: R(255, 255, 255, 0.5)
          c: A 1920x1080 canvas.
          x: A 2D context for that canvas. 
        </code>
        <script>
          (function() {
          var editor = document.querySelector('#editor');
          oldCode = editor.value;
          replaceIframe(oldCode);
          editor.addEventListener('keyup', function() {
          if(editor.value == oldCode) {
          return;
          }
          editor.size = Math.max(editor.value.length, 1);
          replaceIframe(editor.value);
          oldCode = editor.value;
          });

          function replaceIframe(code) {
          var iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-scripts';
          var iframeContent = encodeURIComponent(
          '<!DOCTYPE html>' +
          '<head>' +
            '<style>' +
              '* {padding:0;margin:0;border:0;outline:0;overflow:hidden}' +
              'canvas {' +
              'width: 100%;' +
              'background: white;' +
              '}' +
              '</style>' +
            '</head>' +
          '<body>' +
            '<canvas id=c></canvas>' +
            '<script>' +
              'var c = document.querySelector("#c");' +
              'c.width = 1920;' +
              'c.height = 1080;' +
              'var S = Math.sin;' +
              'var C = Math.cos;' +
              'var T = Math.tan;' +
              'var R = function(r,g,b,a) {' +
              'a = a === undefined ? 1 : a;' +
              'return "rgba("+(r|0)+","+(g|0)+","+(b|0)+","+a+")";' +
              '};' +
              'var x = c.getContext("2d");' +
              'var startT = +new Date(); ' +
              'function u(t) {' +
              code +
              '};' +
              'function loop() {' +
              'requestAnimationFrame(loop);' +
              'u((new Date() - startT) / 1000);' +
              '};' +
              'loop();' +
              '</scr' + 'ipt>');
              iframe.src = 'data:text/html;charset=utf-8,' + iframeContent;
              var container = document.querySelector('#iframe-container-submit');
              container.innerHTML = '';
              container.appendChild(iframe);
              }
              })();

            </script>
          </div>

          {% for dweet in dweet_list %}
          <div class=dweet>
            <div class=canvas-iframe-container-wrapper>
              <div class=canvas-iframe-container 
                id="iframe-container{{ forloop.counter0 }}">
                <script>

                  function decodeHTMLEntities(text) {
                  var entities = [
                  ['apos', '\''],
                  ['amp', '&'],
                  ['lt', '<'],
                  ['gt', '>'],
                  ['#39', '\''],
                  ];

                  for (var i = 0, max = entities.length; i < max; ++i) 
                  text = text.replace(new RegExp('&'+entities[i][0]+';', 'g'), entities[i][1]);

                  return text;
                  }


                  (function() {

                  var iframe = document.createElement('iframe');
                  iframe.sandbox = 'allow-scripts';
                  var iframeContent = encodeURIComponent(
                  '<!DOCTYPE html>' +
                  '<head>' +
                    '<style>' +
                      '* {padding:0;margin:0;border:0;outline:0;overflow:hidden}' +
                      'canvas {' +
                      'width: 100%;' +
                      'background: white;' +
                      '}' +
                      '</style>' +
                    '</head>' +
                  '<body>' +
                    '<canvas id=c></canvas>' +
                    '<script>' +
                      'var c = document.querySelector("#c");' +
                      'c.width = 1920;' +
                      'c.height = 1080;' +
                      'var S = Math.sin;' +
                      'var C = Math.cos;' +
                      'var T = Math.tan;' +
                      'var R = function(r,g,b,a) {' +
                      'a = a === undefined ? 1 : a;' +
                      'return "rgba("+(r|0)+","+(g|0)+","+(b|0)+","+a+")";' +
                      '};' +
                      'var x = c.getContext("2d");' +
                      'var startT = +new Date(); ' +
                      'function u(t) {' +
                      decodeHTMLEntities('{{ dweet.code }}') +
                      '};' +
                      'function loop() {' +
                      'requestAnimationFrame(loop);' +
                      'u((new Date() - startT) / 1000);' +
                      '};' +
                      'loop();' +
                      '</scr' + 'ipt>');
                      iframe.src = 'data:text/html;charset=utf-8,' + iframeContent;
                      var container = document.querySelector('#iframe-container{{ forloop.counter0 }}');
                      container.innerHTML = '';
                      container.appendChild(iframe);
                      })();

                    </script>
                  </div>
                </div>

                <div class=dweet-actions>
                  <a class=score-text> {{ dweet.likes.count }} </a> <a href="{% url 'like' dweet.id %}"> Awesome! </a>
                  <a class=arktis-link id=arktis-link-{{dweet.id}} href="http://arkt.is/t/" >fullscreen at arkt.is</a>
                  <script>
                    (function() {
                    var link = document.querySelector('#arktis-link-{{dweet.id}}');
                    link.href = 'http://arkt.is/t/' + btoa(decodeHTMLEntities('{{ dweet.code }}'));
                    })();
                  </script>
                </div>
                <div class=dweet-author><a href="{% url 'user_feed' dweet.author.username %}">{{ dweet.author.username }}</a></div>
                <div class=dweet-code><code>{{ dweet.code }}</code></div>


              </div>
              {% endfor %}
              <div class=footer>
              </div>
            </div>
          </body>
        </html>
